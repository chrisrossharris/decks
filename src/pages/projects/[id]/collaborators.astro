---
import AppLayout from '@/layouts/AppLayout.astro';
import ProjectSubnav from '@/components/ProjectSubnav.astro';
import { getProject, isProjectOwner, listProjectCollaborators, listProjectInvites } from '@/lib/db/repo';

const userId = Astro.locals.auth().userId;
if (!userId) return Astro.redirect('/login');

const projectId = Astro.params.id as string;
const project = await getProject(userId, projectId);
if (!project) throw new Error('Project not found');

const owner = await isProjectOwner(userId, projectId);
const collaborators = await listProjectCollaborators(projectId);
const invites = await listProjectInvites(projectId);
---

<AppLayout title={`Collaborators - ${project.name}`}>
  <ProjectSubnav projectId={projectId} />

  <section class="grid gap-4 lg:grid-cols-2">
    <article class="card p-4">
      <h2 class="font-display text-xl font-semibold">Team Access</h2>
      <p class="mt-1 text-sm text-slate-600">Owner and accepted partners on this project.</p>
      <div class="mt-3 space-y-2">
        {collaborators.map((member: any) => (
          <div class="rounded-lg border border-slate-200 bg-white p-3 text-sm">
            <p class="font-semibold">{member.user_id}</p>
            <p class="text-xs text-slate-500">{member.role} • {member.status}</p>
          </div>
        ))}
      </div>
    </article>

    <article class="card p-4">
      <h2 class="font-display text-xl font-semibold">Invite Partner</h2>
      {owner ? (
        <form class="mt-3 space-y-3" method="post" action={`/api/projects/${projectId}/invites/create`}>
          <label>
            <p class="label">Invite Email</p>
            <input class="input" type="email" name="invited_email" placeholder="partner@company.com" required />
          </label>
          <label>
            <p class="label">Role</p>
            <input class="input" name="role" value="partner" />
          </label>
          <button class="rounded-md bg-pine px-4 py-2 text-sm font-semibold text-white">Send Invite</button>
        </form>
      ) : (
        <p class="mt-3 text-sm text-slate-600">Only the project owner can create invites.</p>
      )}

      <div class="mt-5">
        <h3 class="font-semibold">Accept Invite</h3>
        <p class="text-xs text-slate-500">Paste invite code shared by project owner.</p>
        <form class="mt-2 flex gap-2" method="post" action={`/api/projects/${projectId}/invites/accept`}>
          <input class="input mt-0" name="invite_code" placeholder="invite code" required />
          <button class="rounded-md bg-ink px-3 py-2 text-sm font-semibold text-white">Accept</button>
        </form>
      </div>
    </article>
  </section>

  <section class="mt-4 card p-4">
    <h2 class="font-display text-lg font-semibold">Invite History</h2>
    <div class="mt-3 space-y-2">
      {invites.length === 0 ? (
        <p class="text-sm text-slate-600">No invites yet.</p>
      ) : invites.map((invite: any) => (
        <div class="rounded-lg border border-slate-200 bg-white p-3 text-sm">
          <p class="font-semibold">{invite.invited_email}</p>
          <p class="text-xs text-slate-500">{invite.status} • role: {invite.role}</p>
          <p class="mt-1 text-xs text-slate-500">code: <span class="font-mono">{invite.invite_code}</span></p>
        </div>
      ))}
    </div>
  </section>
</AppLayout>
