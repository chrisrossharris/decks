---
import AppLayout from '@/layouts/AppLayout.astro';
import LaborPlanner from '@/components/LaborPlanner';
import ProjectSubnav from '@/components/ProjectSubnav.astro';
import { getProject, latestLaborPlan, listLaborTemplates } from '@/lib/db/repo';

const userId = Astro.locals.auth().userId;
if (!userId) return Astro.redirect('/login');

const projectId = Astro.params.id as string;
const project = await getProject(userId, projectId);
if (!project) throw new Error('Project not found');

const templates = await listLaborTemplates(userId);
const defaultPlan = await latestLaborPlan(projectId);
---

<AppLayout title={`Labor - ${project.name}`}>
  <ProjectSubnav projectId={projectId} />
  <LaborPlanner client:load projectId={projectId} templates={templates} defaultPlan={defaultPlan?.labor_json ?? defaultPlan} />
</AppLayout>
