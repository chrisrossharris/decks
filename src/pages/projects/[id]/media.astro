---
import AppLayout from '@/layouts/AppLayout.astro';
import ProjectSubnav from '@/components/ProjectSubnav.astro';
import { getProject, listProjectImages } from '@/lib/db/repo';

const userId = Astro.locals.auth().userId;
if (!userId) return Astro.redirect('/login');

const projectId = Astro.params.id as string;
const project = await getProject(userId, projectId);
if (!project) throw new Error('Project not found');

const images = await listProjectImages(projectId);
---

<AppLayout title={`Project Images - ${project.name}`}>
  <ProjectSubnav projectId={projectId} />

  <section class="card p-4">
    <h2 class="font-display text-xl font-semibold">Upload Site / Design Images</h2>
    <p class="mt-1 text-sm text-slate-600">Allowed: PNG, JPG, WEBP, GIF up to 10MB.</p>
    <form class="mt-3 grid gap-3 sm:grid-cols-3" method="post" enctype="multipart/form-data" action={`/api/projects/${projectId}/images/upload`}>
      <label class="sm:col-span-2">
        <p class="label">Image File</p>
        <input class="input" type="file" name="image" accept="image/*" required />
      </label>
      <label>
        <p class="label">Caption (optional)</p>
        <input class="input" name="caption" placeholder="North elevation" />
      </label>
      <div class="sm:col-span-3">
        <button class="rounded-md bg-pine px-4 py-2 text-sm font-semibold text-white">Upload Image</button>
      </div>
    </form>
  </section>

  <section class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
    {images.length === 0 ? (
      <div class="card p-4 text-sm text-slate-600">No images uploaded yet.</div>
    ) : images.map((image: any) => (
      <article class="card overflow-hidden">
        <img src={`/api/projects/${projectId}/images/${image.id}`} alt={image.caption || image.file_name} class="h-48 w-full object-cover" />
        <div class="p-3">
          <p class="text-sm font-semibold">{image.file_name}</p>
          <p class="text-xs text-slate-500">{image.caption || 'No caption'}</p>
          <a class="mt-2 inline-block text-xs text-pine underline" href={`/api/projects/${projectId}/images/${image.id}`} target="_blank">Open full image</a>
        </div>
      </article>
    ))}
  </section>
</AppLayout>
