---
import AppLayout from '@/layouts/AppLayout.astro';
import ProjectSubnav from '@/components/ProjectSubnav.astro';
import { getProject, getScheduleHandoff, listProposalReviews } from '@/lib/db/repo';

const userId = Astro.locals.auth().userId;
if (!userId) return Astro.redirect('/login');

const projectId = Astro.params.id as string;
const project = await getProject(userId, projectId);
if (!project) throw new Error('Project not found');

const handoff = await getScheduleHandoff(projectId);
const reviews = await listProposalReviews(projectId);
const approved = reviews.find((r: any) => r.decision === 'approved');
const stage = handoff?.stage ?? 'backlog';
---

<AppLayout title={`Schedule Handoff - ${project.name}`}>
  <ProjectSubnav projectId={projectId} />
  <section class="mb-4 card p-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <h2 class="font-display text-lg font-semibold">What to do next</h2>
        <p class="mt-1 text-sm text-slate-600">Finalize schedule details, assign a lead, and move the project to active production.</p>
      </div>
      <a
        href="/projects/schedule"
        class:list={[
          'rounded-md px-4 py-2 text-sm font-semibold',
          stage === 'scheduled' || stage === 'in_progress' || stage === 'done' ? 'bg-pine text-white' : 'btn-disabled'
        ]}
        aria-disabled={!(stage === 'scheduled' || stage === 'in_progress' || stage === 'done')}
      >
        {stage === 'scheduled' || stage === 'in_progress' || stage === 'done' ? 'View Schedule Board' : 'Set Stage To Scheduled First'}
      </a>
    </div>
    <div class="mt-3 grid gap-2 text-sm sm:grid-cols-3">
      <div class="rounded-md border border-slate-700 px-3 py-2">
        <span class={approved ? 'status-done' : 'status-pending'}>{approved ? 'Done' : 'Pending'}</span>
        <p class="font-semibold">Client Approval</p>
      </div>
      <div class="rounded-md border border-slate-700 px-3 py-2">
        <span class={handoff?.assigned_lead ? 'status-done' : 'status-pending'}>{handoff?.assigned_lead ? 'Done' : 'Pending'}</span>
        <p class="font-semibold">Assigned Lead</p>
      </div>
      <div class="rounded-md border border-slate-700 px-3 py-2">
        <span class={(stage === 'scheduled' || stage === 'in_progress' || stage === 'done') ? 'status-done' : 'status-pending'}>
          {(stage === 'scheduled' || stage === 'in_progress' || stage === 'done') ? 'Done' : 'Pending'}
        </span>
        <p class="font-semibold">Scheduled Stage</p>
      </div>
    </div>
  </section>
  <section class="card p-4">
    <h2 class="font-display text-lg font-semibold">Scheduling Handoff</h2>
    <p class="mt-1 text-sm text-slate-600">Capture scheduling readiness after client decision and move through simple stage tracking.</p>
    {approved ? (
      <p class="alert-success mt-2">
        Approved by {approved.reviewer_name} on {new Date(approved.created_at).toLocaleString()}
      </p>
    ) : (
      <p class="alert-warn mt-2">
        No recorded approval yet. You can still set preliminary schedule details.
      </p>
    )}
    <form class="mt-4 grid gap-3 sm:grid-cols-2" method="post" action={`/api/projects/${projectId}/schedule`}>
      <label>
        <p class="label">Stage</p>
        <select class="input" name="stage" required>
          {['backlog', 'ready', 'scheduled', 'in_progress', 'done'].map((stage) => (
            <option value={stage} selected={(handoff?.stage ?? 'backlog') === stage}>{stage.replaceAll('_', ' ')}</option>
          ))}
        </select>
      </label>
      <label>
        <p class="label">Estimated Duration (days)</p>
        <input class="input" type="number" min="1" name="estimated_duration_days" value={handoff?.estimated_duration_days ?? ''} />
      </label>
      <label>
        <p class="label">Preferred Start</p>
        <input class="input" type="date" name="preferred_start_date" value={handoff?.preferred_start_date?.toString().slice(0, 10) ?? ''} />
      </label>
      <label>
        <p class="label">Scheduled Start</p>
        <input class="input" type="date" name="scheduled_start_date" value={handoff?.scheduled_start_date?.toString().slice(0, 10) ?? ''} />
      </label>
      <label>
        <p class="label">Target Completion</p>
        <input class="input" type="date" name="target_completion_date" value={handoff?.target_completion_date?.toString().slice(0, 10) ?? ''} />
      </label>
      <label>
        <p class="label">Assigned Lead</p>
        <input class="input" name="assigned_lead" value={handoff?.assigned_lead ?? ''} />
      </label>
      <label class="sm:col-span-2">
        <p class="label">Notes</p>
        <textarea class="input min-h-[100px]" name="notes">{handoff?.notes ?? ''}</textarea>
      </label>
      <div class="sm:col-span-2">
        <button class="rounded-md bg-pine px-4 py-2 text-sm font-semibold text-white">Save Handoff</button>
      </div>
    </form>
  </section>
</AppLayout>
