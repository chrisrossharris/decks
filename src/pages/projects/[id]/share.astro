---
import AppLayout from '@/layouts/AppLayout.astro';
import ProjectSubnav from '@/components/ProjectSubnav.astro';
import { getProject, listProjectActivity, listProjectShareLinks, listProposalReviews } from '@/lib/db/repo';

const userId = Astro.locals.auth().userId;
if (!userId) return Astro.redirect('/login');

const projectId = Astro.params.id as string;
const project = await getProject(userId, projectId);
if (!project) throw new Error('Project not found');

const links = await listProjectShareLinks(projectId);
const reviews = await listProposalReviews(projectId);
const activity = await listProjectActivity(projectId);
const origin = Astro.url.origin;
const isFence = project.type === 'fence';
const hasActiveEstimateLink = links.some((l: any) => l.kind === 'estimate' && l.is_active);
const hasDecision = reviews.length > 0;
---

<AppLayout title={`Share With Client - ${project.name}`}>
  <ProjectSubnav projectId={projectId} />

  <section class="mb-4 card p-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <h2 class="font-display text-lg font-semibold">What to do next</h2>
        <p class="mt-1 text-sm text-slate-600">Create a review link, collect client response, then move to scheduling handoff.</p>
      </div>
      <a
        href={hasDecision ? `/projects/${projectId}/schedule` : '#'}
        class:list={[
          'rounded-md px-4 py-2 text-sm font-semibold',
          hasDecision ? 'bg-pine text-white' : 'btn-disabled'
        ]}
        aria-disabled={!hasDecision}
      >
        {hasDecision ? 'Next: Scheduling Handoff' : 'Await Client Decision'}
      </a>
    </div>
    <div class="mt-3 grid gap-2 text-sm sm:grid-cols-3">
      <div class="rounded-md border border-slate-700 px-3 py-2">
        <span class={hasActiveEstimateLink ? 'status-done' : 'status-pending'}>{hasActiveEstimateLink ? 'Done' : 'Pending'}</span>
        <p class="font-semibold">Estimate Link Shared</p>
      </div>
      <div class="rounded-md border border-slate-700 px-3 py-2">
        <span class={hasDecision ? 'status-done' : 'status-pending'}>{hasDecision ? 'Done' : 'Pending'}</span>
        <p class="font-semibold">Client Decision Recorded</p>
      </div>
      <div class="rounded-md border border-slate-700 px-3 py-2">
        <span class={(project.schedule_stage ?? 'backlog') !== 'backlog' ? 'status-done' : 'status-pending'}>
          {(project.schedule_stage ?? 'backlog') !== 'backlog' ? 'Done' : 'Pending'}
        </span>
        <p class="font-semibold">Scheduling Started</p>
      </div>
    </div>
  </section>

  <section class="grid gap-4 lg:grid-cols-2">
    <article class="card p-4">
      <h2 class="font-display text-xl font-semibold">Create Review Link</h2>
      <p class="mt-1 text-sm text-slate-600">
        Generate a secure public link for client {isFence ? 'fence plan' : 'blueprint'} or estimate review.
      </p>
      <form class="mt-3 grid gap-3" method="post" action={`/api/projects/${projectId}/share/create`}>
        <label>
          <p class="label">Review Type</p>
          <select class="input" name="kind" required>
            <option value="blueprint">{isFence ? 'Fence Plan' : 'Blueprint'}</option>
            <option value="estimate">Estimate</option>
          </select>
        </label>
        <label>
          <p class="label">Client Email (optional)</p>
          <input class="input" type="email" name="client_email" placeholder="client@example.com" />
        </label>
        <label>
          <p class="label">Expires At (optional)</p>
          <input class="input" name="expires_at" type="datetime-local" />
        </label>
        <button class="rounded-md bg-pine px-4 py-2 text-sm font-semibold text-white">Create Link</button>
      </form>
    </article>

    <article class="card p-4">
      <h2 class="font-display text-xl font-semibold">How Client Review Works</h2>
      <ul class="mt-3 space-y-2 text-sm text-slate-700">
        <li>{isFence ? 'Fence plan link' : 'Blueprint link'}: design inputs + project image gallery.</li>
        <li>Estimate link: top-line estimate summary totals.</li>
        <li>Links are tokenized and can be revoked anytime.</li>
      </ul>
    </article>
  </section>

  <section class="mt-4 card p-4">
    <h2 class="font-display text-lg font-semibold">Active + Previous Links</h2>
    <div class="mt-3 space-y-2">
      {links.length === 0 ? (
        <p class="text-sm text-slate-600">No share links yet.</p>
      ) : links.map((link: any) => (
        <div class="rounded-lg border border-slate-200 bg-white p-3 text-sm">
          <p class="font-semibold">{link.kind} • {link.is_active ? 'active' : 'revoked'}</p>
          <a class="text-pine underline break-all" href={`${origin}/review/${link.token}`} target="_blank">{origin}/review/{link.token}</a>
          <p class="text-xs text-slate-500">expires: {link.expires_at ? new Date(link.expires_at).toLocaleString() : 'never'}</p>
          {link.is_active && (
            <form class="mt-2" method="post" action={`/api/projects/${projectId}/share/revoke`}>
              <input type="hidden" name="link_id" value={link.id} />
              <button class="rounded-md border border-rose-300 px-2 py-1 text-xs font-semibold text-rose-700">Revoke Link</button>
            </form>
          )}
        </div>
      ))}
    </div>
  </section>

  <section class="mt-4 grid gap-4 lg:grid-cols-2">
    <article class="card p-4">
      <h2 class="font-display text-lg font-semibold">Client Decisions</h2>
      <div class="mt-3 space-y-2">
        {reviews.length === 0 ? (
          <p class="text-sm text-slate-600">No client responses yet.</p>
        ) : reviews.map((review: any) => (
          <div class="rounded-lg border border-slate-700 p-3 text-sm">
            <p class="font-semibold">{review.decision === 'approved' ? 'Approved' : 'Changes Requested'}</p>
            <p class="text-xs text-slate-500">{new Date(review.created_at).toLocaleString()}</p>
            <p class="mt-1 text-slate-600">By: {review.reviewer_name}{review.reviewer_email ? ` (${review.reviewer_email})` : ''}</p>
            {review.approved_amount !== null && <p class="mt-1">Approved Amount: ${review.approved_amount}</p>}
            {review.message && <p class="mt-1 text-slate-600">{review.message}</p>}
          </div>
        ))}
      </div>
    </article>

    <article class="card p-4">
      <h2 class="font-display text-lg font-semibold">Activity Timeline</h2>
      <div class="mt-3 space-y-2">
        {activity.length === 0 ? (
          <p class="text-sm text-slate-600">No tracked activity yet.</p>
        ) : activity.map((event: any) => (
          <div class="rounded-lg border border-slate-700 p-3 text-sm">
            <p class="font-semibold">{event.event_key.replaceAll('_', ' ')}</p>
            <p class="text-xs text-slate-500">{new Date(event.created_at).toLocaleString()}</p>
            <p class="mt-1 text-slate-600">Actor: {event.actor}{event.actor_ref ? ` • ${event.actor_ref}` : ''}</p>
          </div>
        ))}
      </div>
    </article>
  </section>
</AppLayout>
