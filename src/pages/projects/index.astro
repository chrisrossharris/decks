---
import AppLayout from '@/layouts/AppLayout.astro';
import { listProjects } from '@/lib/db/repo';

const userId = Astro.locals.auth().userId;
if (!userId) return Astro.redirect('/login');

const projects = await listProjects(userId);
---

<AppLayout title="Projects">
  <div class="mb-4 flex justify-end">
    <a href="/projects/new" class="rounded-md bg-pine px-4 py-2 text-sm font-semibold text-white">New Project</a>
  </div>
  {projects.length === 0 ? (
    <div class="card p-6">
      <p class="font-semibold">No projects yet</p>
      <p class="mt-1 text-sm text-slate-600">
        Create your first project to start the takeoff flow. If you ran seeding, those rows may belong to a different user ID.
      </p>
      <a href="/projects/new" class="mt-4 inline-block rounded-md bg-pine px-4 py-2 text-sm font-semibold text-white">Create Project</a>
    </div>
  ) : (
    <div class="grid gap-3">
      {projects.map((project) => (
        <div class="card p-4" key={project.id}>
          <div class="flex items-center justify-between gap-3">
            <a href={`/projects/${project.id}/inputs`} class="min-w-0 flex-1 hover:text-pine">
              <p class="font-semibold">{project.name}</p>
              <p class="text-xs text-slate-500">{project.type} • {project.status}</p>
              <p class="text-xs text-slate-500">
                client: {project.latest_client_decision ?? 'no decision'} • schedule: {project.schedule_stage ?? 'backlog'}
              </p>
              <p class="text-xs text-slate-500">{project.address}</p>
            </a>
            <form
              method="post"
              action={`/api/projects/${project.id}/delete`}
              onsubmit="return confirm('Delete this project and all related versions/items/labor/estimates/documents? This cannot be undone.');"
            >
              <button class="rounded-md border border-rose-300 px-3 py-1.5 text-xs font-semibold text-rose-700 hover:bg-rose-50">
                Delete
              </button>
            </form>
          </div>
        </div>
      ))}
    </div>
  )}
</AppLayout>
